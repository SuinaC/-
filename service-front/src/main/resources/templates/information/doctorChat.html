<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<!-- START: Head-->
<head>
    <meta charset="UTF-8">
    <title>医生咨询</title>
    <link rel="shortcut icon" href="dist/images/favicon.ico" th:href="@{/information/}"/>
    <meta name="viewport" content="width=device-width,initial-scale=1">

    <!-- START: Template CSS-->
    <link rel="stylesheet" href="dist/vendors/bootstrap/css/bootstrap.min.css"
          th:href="@{/information/vendors/bootstrap/css/bootstrap.min.css}">
    <link rel="stylesheet" href="dist/vendors/jquery-ui/jquery-ui.min.css"
          th:href="@{/information/vendors/jquery-ui/jquery-ui.min.css}">
    <link rel="stylesheet" href="dist/vendors/jquery-ui/jquery-ui.theme.min.css"
          th:href="@{/information/vendors/jquery-ui/jquery-ui.theme.min.css}">
    <link rel="stylesheet" href="dist/vendors/simple-line-icons/css/simple-line-icons.css"
          th:href="@{/information/vendors/simple-line-icons/css/simple-line-icons.css}">
    <link rel="stylesheet" href="dist/vendors/flags-icon/css/flag-icon.min.css"
          th:href="@{/information/vendors/flags-icon/css/flag-icon.min.css}">
    <link rel="stylesheet" href="dist/vendors/flag-select/css/flags.css"
          th:href="@{/information/vendors/flag-select/css/flags.css}">
    <link rel="stylesheet" href="dist/vendors/sweetalert/sweetalert.css"
          th:href="@{/information/vendors/sweetalert/sweetalert.css}">
    <link rel="stylesheet" href="assets/plugins/fontawesome/css/all.min.css"
          th:href="@{/information/css/style.css}">
    <link rel="stylesheet" href="assets/css/style.css" th:href="@{/information/css/all.min.css}">
    <link rel="stylesheet" href="assets/css/style.css" th:href="@{/information/css/fontawesome.min.css}">
    <!-- END Template CSS-->

    <!-- START: Custom CSS-->
    <link rel="stylesheet" href="dist/css/main.css" th:href="@{/information/css/main.css}">
    <link rel="stylesheet" href="dist/css/main.css" th:href="@{/information/css/bigImg.css}">
    <link rel="stylesheet" href="dist/vendors/icofont/icofont.min.css"
          th:href="@{/information/vendors/icofont/icofont.min.css}">
    <!-- END: Custom CSS-->
</head>
<!-- END Head-->

<!-- START: Body-->
<body id="main-container" class="default">
<!-- START: Pre Loader-->
<div class="se-pre-con">
    <img src="dist/images/logo.png" th:src="@{/information/images/logo.png}" alt="logo" width="23" class="img-fluid"/>
</div>
<!-- END: Pre Loader-->

<!-- START: Header-->
<div id="header-fix" class="header fixed-top">
    <nav class="navbar navbar-expand-lg  p-0">
        <div class="navbar-header h4 mb-0 align-self-center logo-bar text-center">
            <a href="index.html" class="horizontal-logo text-center">
                <span class="h3 align-self-center mb-0 ">用户主页</span>
            </a>
        </div>
        <div class="navbar-header h4 mb-0 text-center h-100 collapse-menu-bar">
            <a href="#" class="sidebarCollapse" id="collapse"><i class="icon-menu body-color"></i></a>
        </div>

        <form class="float-left d-none d-lg-block search-form">
            <div class="form-group mb-0 position-relative">
                <input type="text" class="form-control border-0 rounded bg-search pl-5" id="searchDisease" th:onblur="'javascript:searchDisease('+${tConsumer.id}+')'" placeholder="请输入病症">
                <div class="btn-search position-absolute top-0">
                    <a th:onclick="'javascript:searchDisease('+${tConsumer.id}+')'" ><i class="h5 icon-magnifier body-color"></i></a>
                </div>
                <a href="#" class="position-absolute close-button mobilesearch d-lg-none" data-toggle="dropdown"
                   aria-expanded="false"><i class="icon-close h5"></i>
                </a>

            </div>
        </form>
        <div class="navbar-right ml-auto h-100">
            <ul class="ml-auto p-0 m-0 list-unstyled d-flex top-icon h-100">
                <li class="d-inline-block align-self-center  d-block d-lg-none">
                    <a href="#" class="nav-link mobilesearch" data-toggle="dropdown" aria-expanded="false"><i
                            class="icon-magnifier h4"></i>
                    </a>
                </li>
                <li class="dropdown user-profile align-self-center d-inline-block">
                    <a href="#" class="nav-link py-0" data-toggle="dropdown" aria-expanded="false">
                        <div class="media">
                            <img src="dist/images/author.jpg" th:src="@{${tConsumer.img}}" alt=""
                                 class="d-flex img-fluid rounded-circle" width="29">
                        </div>
                    </a>

                    <div class="dropdown-menu  dropdown-menu-right p-0">
                        <a th:href="@{/consumerInformation/updateInformation(id=${tConsumer.id})}"
                           class="dropdown-item px-2 align-self-center d-flex">
                            <span class="icon-pencil mr-2 h6 mb-0"></span> 编辑个人资料</a>
                        <a th:href="@{/consumerInformation/information(id=${tConsumer.id})}"
                           class="dropdown-item px-2 align-self-center d-flex">
                            <span class="icon-user mr-2 h6 mb-0"></span> 查看资料</a>
                        <div class="dropdown-divider"></div>

                        <div class="dropdown-divider"></div>
                        <a href="/consumer/login" class="dropdown-item px-2 text-danger align-self-center d-flex">
                            <span class="icon-logout mr-2 h6  mb-0"></span>登出</a>
                    </div>

                </li>

            </ul>
        </div>
    </nav>
</div>
<!-- END: Header-->

<!-- START: Main Menu-->
<div class="sidebar">
    <div class="media d-block text-center user-profile">
        <img class="img-fluid" src="dist/images/author1.jpg" style="width: 100px; hight:100px"
             th:src="@{${tConsumer.img}}" alt="">
        <div class="media-body text-center mt-0 color-primary mt-2">
            <a href="#" class="nav-link py-0" data-toggle="dropdown" aria-expanded="false">
                <h6 class="mb-0 font-weight-bold" th:text="${tConsumer.name}">姓名</h6>
                <p th:text="${tConsumer.nativePlace}"></p>
            </a>
            <div class="dropdown-menu dropdown-menu-right p-0" style="">
                <a th:href="@{/consumerInformation/updateInformation(id=${tConsumer.id})}"
                   class="dropdown-item px-2 align-self-center d-flex">
                    <span class="icon-pencil mr-2 h6 mb-0"></span> 编辑个人资料</a>
                <a th:href="@{/consumerInformation/information(id=${tConsumer.id})}"
                   class="dropdown-item px-2 align-self-center d-flex">
                    <span class="icon-user mr-2 h6 mb-0"></span> 查看资料</a>
                <div class="dropdown-divider"></div>

                <div class="dropdown-divider"></div>
                <a href="/consumer/login" class="dropdown-item px-2 text-danger align-self-center d-flex">
                    <span class="icon-logout mr-2 h6  mb-0"></span> 登出</a>
            </div>
        </div>
    </div>

    <!-- START: Menu-->
    <ul id="side-menu" class="sidebar-menu">
        <li class="dropdown active"><a href="#">首页</a>
            <ul>
                <li class="active"><a href="index.html" th:href="@{/consumerInformation/index(id=${tConsumer.id})}"><i class="icon-rocket"></i> 首页</a></li>
            </ul>
        </li>
        <li class="dropdown"><a href="#">应用</a>
            <ul>
                <li><a th:href="@{/consumerInformation/calendar(id=${tConsumer.id})}"><i class="icon-calendar"></i> 日历备忘录</a></li>

                <li class="dropdown"><a href="#"><i class="icon-envelope"></i>邮箱</a>
                    <ul class="sub-menu">
                        <li><a th:href="@{/mailInbox/mail(id=${tConsumer.id})}"><i class="icon-envelope"></i> 收件箱</a></li>
                    </ul>
                </li>
                <li><a th:href="@{/consumerOrder/consumerOrder(id=${tConsumer.id})}"><i class="icon icofont-ui-copy"></i> 预约</a></li>
                        <li><a th:href="@{/consumerOrder/medicalOrder(id=${tConsumer.id})}"><i class="icon icofont-first-aid"></i> 体检预约</a></li>
                <li><a th:href="@{/consumerInformation/prescriptionList(id=${tConsumer.id})}"><i class="icon icofont-ui-clip-board"></i> 查看处方</a></li>
                <li><a th:href="@{/consumerInformation/searchDoctor(id=${tConsumer.id})}"><i class="icon icofont-doctor"></i> 查找医生</a></li>
               <li><a th:href="@{/consumerInformation/doctorCollection(id=${tConsumer.id})}"><i class="icon icofont-heart"></i> 医生收藏</a></li>
                        <li><a th:href="@{/drug/drugOrderList(id=${tConsumer.id})}"><i class="icon icofont-ticket"></i> 查看药品订单列表</a></li>
            </ul>
        </li>
        <li class="dropdown"><a href="#">信息</a>
            <ul>
                <li class="dropdown"><a href="#"><i class="icon-user"></i>个人信息</a>
                    <ul class="sub-menu">
                        <li><a th:href="@{/consumerInformation/information(id=${tConsumer.id})}"><i class="icon-disc"></i> 查看个人信息</a></li>
                        <li><a th:href="@{/consumerInformation/updateInformation(id=${tConsumer.id})}"><i class="icon-disc"></i> 修改个人信息</a></li>
                        <li><a th:href="@{/consumerInformation/updatePassword(id=${tConsumer.id})}"><i class="icon-disc"></i> 修改密码</a></li>
                    </ul>
                </li>
                <li class="dropdown"><a href="#"><i class="icon-paper-clip"></i>病历</a>
                    <ul class="sub-menu">
                        <li><a th:href="@{/consumerInformation/medical(id=${tConsumer.id})}"><i class="icon-disc"></i>历史病历</a></li>
                        <li><a th:href="@{/consumerInformation/existingMedical(id=${tConsumer.id})}"><i class="icon-cursor-move"></i>现有病历</a></li>
                    </ul>
                </li>
                <li class="dropdown"><a href="#"><i class="icon icofont-restaurant-menu"></i>预约信息</a>
                    <ul class="sub-menu">
                       <li><a th:href="@{/consumerOrder/appointmentProgress(id=${tConsumer.id})}"><i class="icon-disc"></i> 预约进度</a></li>
                                <li><a th:href="@{/consumerInformation/consumerOrderList(id=${tConsumer.id})}"><i class="icon-disc"></i> 预约列表</a></li>
                        <li><a th:href="@{/consumerOrder/medicalAppointmentList(id=${tConsumer.id})}"><i class="icon-disc"></i> 体检预约列表</a></li>
                    </ul>
                </li>
            </ul>
        </li>
    </ul>
    <!-- END: Menu-->
</div>
<!-- END: Main Menu-->

<!-- START: Main Content-->
<main>
    <div class="container-fluid">
        <!-- START: Breadcrumbs-->
        <div class="row ">
            <input hidden="hidden" id="id" name="id" th:value="${tConsumer.id}">
            <div class="col-12  align-self-center">
                <div class="sub-header mt-3 py-3 px-3 align-self-center d-sm-flex w-100 rounded">
                    <div class="w-sm-100 mr-auto"><h4 class="mb-0">医生咨询</h4></div>
                </div>
            </div>
        </div>
        <!-- END: Breadcrumbs-->

        <!-- START: Card Data-->
        <div class="row">
            <div class="col-xl-12">
                <div class="chat-window">
                    <input hidden="hidden" th:value="${tConsumer.id}" id="consumerId" name="consumerId">
                    <input hidden="hidden" th:value="${tDoctor.id}" id="doctorId" name="doctorId">
                <!-- Chat Right -->
                    <div class="chat-cont-right">
                        <div class="chat-header">
                            <a id="back_user_list" href="javascript:void(0)" class="back-user-list">
                                <i class="material-icons"></i>
                            </a>
                            <div class="media">
                                <div class="media-img-wrap">
                                    <div class="avatar avatar-online">
                                        <img th:src="${tDoctor.img}" id="image_normal" alt="User Image"
                                        class="avatar-img rounded-circle">
                                        <div   id="image_large"></div>
                                    </div>
                                </div>
                                <div class="media-body">
                                    <div class="user-name" th:text="${tDoctor.name}"></div>
                                    <div class="user-status" th:text="${tDoctor.title}"></div>
                                </div>
                            </div>
                            <div class="chat-options">
                                <a href="javascript:void(0)">
                                    <i class="material-icons"></i>
                                </a>
                            </div>
                        </div>
                        <div class="chat-body" th:if="${tChatMessages.size()} eq 0">
                            <div class="chat-scroll" id="chatBodyNull">
                            </div>
                        </div>
                        <div class="chat-body"   th:fragment="chat_refresh"
                             th:id="id_chat_refresh" >
                            <div class="chat-scroll" id="chatBody">
                                <ul class="list-unstyled" >
                                    <div th:each="p : ${tChatMessages}">
                                        <li class="media sent" th:if="${p.getFromId()} eq ${p.getConsumerId()}">
                                            <div class="media-body" >
                                                <div class="msg-box" >
                                                    <div>
                                                        <p th:text="${p.getMessage()}">Hello. What can I do for you?</p>
                                                        <ul class="chat-msg-info">
                                                            <li>
                                                                <div class="chat-time">
                                                                    <span th:text="${#dates.format(p.gmtCreate,'yyyy年MM月dd日 HH:mm:ss')}">8:30 AM</span>
                                                                </div>
                                                            </li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </li>
                                        <ul  class="list-unstyled" th:if="${p.getFromId()} eq ${p.getDoctorId()}">
                                        <li class="media received">
                                            <div class="avatar">
                                                <img th:src="${p.tDoctor.getImg()}" alt="User Image"
                                                     class="avatar-img rounded-circle">
                                            </div>
                                            <div class="media-body">
                                                <div class="msg-box">
                                                    <div>
                                                        <p th:text="${p.getMessage()}">I'm just looking around.</p>
                                                        <ul class="chat-msg-info">
                                                            <li>
                                                                <div class="chat-time">
                                                                    <span th:text="${#dates.format(p.gmtCreate,'yyyy年MM月dd日 HH:mm:ss')}">8:35 AM</span>
                                                                </div>
                                                            </li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </li>
                                        </ul>
                                    </div>
                                </ul>
                            </div>
                        </div>
                        <div class="chat-footer">
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <div class="btn-file btn">
                                        <i class="fa fa-paperclip"></i>
                                        <input type="file">
                                    </div>
                                </div>
                                <input type="text" id="message"  onkeypress="EnterPress(event)" class="input-msg-send form-control" placeholder="">
                                <div class="input-group-append">
                                    <button type="button" onclick="sendMessage()" class="btn msg-send-btn"><i class="fab fa-telegram-plane"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Chat Left -->
                    <div class="chat-cont-left">
                        <!--                    <img th:src="${tDoctor.img}">-->
                        <center>
                            <div class="doctor-img">
                                <a th:href="@{/doctorInformation/doctorProfile(id=${tDoctor.id},consumerId=${tConsumer.id})}">
                                    <img th:src="${tDoctor.img}"  style="width: 150px;height: 200px;margin-left:10px" class="img-fluid" alt="User Image">
                                </a>
                            </div>
                            <h3 th:text="${tDoctor.name}"></h3>
                            <h5 th:text="${tDoctor.title}"></h5>
                        </center>
                            <p style="text-indent:2em;" th:text="${tDoctor.introduction}"></p>
                            <h3 th:text="${tDoctor.email}"></h3>
                            <h3 th:text="${tDoctor.address}"></h3>
                    </div>
                    <!-- /Chat Left -->
                    <!-- /Chat Right -->
                </div>
            </div>
        </div>
        <!-- END: Card DATA-->
    </div>
</main>
<!-- END: Content-->


<!-- START: Back to top-->
<a href="#" class="scrollup text-center">
    <i class="icon-arrow-up"></i>
</a>
<!-- END: Back to top-->

<!-- START: Template JS-->
<script src="dist/vendors/jquery/jquery-3.3.1.min.js"
        th:src="@{/information/vendors/jquery/jquery-3.3.1.min.js}"></script>
<script src="dist/vendors/jquery-ui/jquery-ui.min.js"
        th:src="@{/information/vendors/jquery-ui/jquery-ui.min.js}"></script>
<script src="dist/vendors/moment/moment.js" th:src="@{/information/vendors/moment/moment.js}"></script>
<script src="dist/vendors/bootstrap/js/bootstrap.bundle.min.js"
        th:src="@{/information/vendors/bootstrap/js/bootstrap.bundle.min.js}"></script>
<script src="dist/vendors/slimscroll/jquery.slimscroll.min.js"
        th:src="@{/information/vendors/slimscroll/jquery.slimscroll.min.js}"></script>
<script src="dist/vendors/flag-select/js/jquery.flagstrap.min.js"
        th:src="@{/information/vendors/flag-select/js/jquery.flagstrap.min.js}"></script>
<script src="dist/vendors/sweetalert/sweetalert.min.js"
        th:src="@{/information/vendors/sweetalert/sweetalert.min.js}"></script>
<!-- END: Template JS-->
<!-- END: Template JS-->

<!-- START: APP JS-->
<script src="dist/js/app.js" th:src="@{/information/js/app.js}"></script>
<!-- END: APP JS-->
<script type="text/javascript">

</script>
<script type="text/javascript">
    var socket;
    window.onload = function (){
        $("#chatBody").scrollTop($("#chatBody")[0].scrollHeight);
        // var height = screen.height;
        // var hei  = height - height * 0.36 ;
        //
        // $("#chatBody").attr("style","height:" + hei + "px");
        // $("#chatBodyNull").attr("style","height:" + hei + "px");
        if(typeof(WebSocket) == "undefined") {
            console.log("您的浏览器不支持WebSocket");
        }else{
            console.log("您的浏览器支持WebSocket");
            //实现化WebSocket对象，指定要连接的服务器地址与端口  建立连接
            var userId = $("#consumerId").val()
            // var socketUrl="ws://127.0.0.1:22599/webSocket/"+userId;
            var socketUrl="ws://localhost:8081/doctorChat/"+userId;
            console.log(socketUrl);
            if(socket!=null){
                socket.close();
                socket=null;
            }
            socket = new WebSocket(socketUrl);
            //打开事件
            socket.onopen = function() {
                console.log("websocket已打开");
                //socket.send("这是来自客户端的消息" + location.href + new Date());
            };
            //获得消息事件
            socket.onmessage = function(msg) {
                var doctorId = $("#doctorId").val();
                var consumerId = $("#consumerId").val();
                var message = msg.data;
                if(message != null){
                    var key;
                    message = JSON.parse(message);
                    var fromUserId;
                    var toUserId;
                    var contentText;
                    for (key in message){
                        if(key == "fromUserId"){
                            fromUserId = message[key];
                        }
                        if(key == "toUserId"){
                            toUserId =  message[key];
                        }
                        if(key == "contentText"){
                            contentText = message[key];
                        }
                    }
                    if (fromUserId == doctorId && toUserId == consumerId){
                        $.post(
                            "/doctorChat/freshChat",
                            "consumerId=" + consumerId + "&doctorId=" + doctorId,
                            function (data){
                                if(data == "error"){
                                    console.log("服务器错误，请稍后再试");
                                }else {
                                    $("#id_chat_refresh").html(data);
                                    $("#chatBody").scrollTop($("#chatBody")[0].scrollHeight);
                                }
                            }
                        )
                    }
                }


                console.log(msg.data);
                //发现消息进入    开始处理前端触发逻辑
            };
            //关闭事件
            socket.onclose = function() {
                console.log("websocket已关闭");
            };
            //发生了错误事件
            socket.onerror = function() {
                console.log("websocket发生了错误");
            }
        }
    }


    function sendMessage() {
        if(typeof(WebSocket) == "undefined") {
            console.log("您的浏览器不支持WebSocket");
        }else {
            // console.log("您的浏览器支持WebSocket");
            var toUserId = $("#doctorId").val()
            var fromUserId = $("#consumerId").val()
            var contentText = $("#message").val()
            var msg = '{"fromUserId":"'+fromUserId+'","toUserId":"'+toUserId+'","contentText":"'+contentText+'"}';
           $.post(
               "/doctorChat/addChat",
               "fromUserId=" + fromUserId + "&toUserId=" + toUserId + "&contentText=" + contentText,
               function (data){
                   if(data == "error"){
                       console.log("服务器错误，请稍后再试");
                   }else {
                       $("#id_chat_refresh").html(data);
                       $("#chatBody").scrollTop($("#chatBody")[0].scrollHeight);
                       $("#message").val("")
                       socket.send(msg);
                   }
               }
           )
            console.log(msg);

        }
    }

    function EnterPress(e){
        var e = e || window.event;
        if(e.keyCode == 13){
            if(typeof(WebSocket) == "undefined") {
                console.log("您的浏览器不支持WebSocket");
            }else {
                // console.log("您的浏览器支持WebSocket");
                var toUserId = $("#doctorId").val()
                var fromUserId = $("#consumerId").val()
                var contentText = $("#message").val()
                var msg = '{"fromUserId":"'+fromUserId+'","toUserId":"'+toUserId+'","contentText":"'+contentText+'"}';
                $.post(
                    "/doctorChat/addChat",
                    "fromUserId=" + fromUserId + "&toUserId=" + toUserId + "&contentText=" + contentText,
                    function (data){
                        if(data == "error"){
                            console.log("服务器错误，请稍后再试");
                        }else {
                            $("#id_chat_refresh").html(data);
                            $("#chatBody").scrollTop($("#chatBody")[0].scrollHeight);
                            $("#message").val("")
                            socket.send(msg);
                        }
                    }
                )
                console.log(msg);

            }
        }
    }
</script>
<script>
    $(function () {
        $("#image_normal").click(function () {
            var large_image = '<img src= ' + $(this).attr("src") + '></img>';
            console.log(large_image)
            $('#image_large').html($(large_image).css({
                display:"block",
                height: '1000%',
                width: '1000%',
                position: "absolute",
                left: "500%",
                top: "500%",
                transform: "translate(-50%,-50%)",
            }, 500));
            $('#image_large').css( "display","block" );
        });
        $('#image_large').click(function(){
            $(this).css( "display","none" );
        })
    });
</script>
</body>
<!-- END: Body-->
</html>
